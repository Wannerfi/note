[toc]

# lua问题
## 点击背包后关闭背包，控制角色错误的问题
**问题描述**
点击背包后弹出背包界面，关闭背包界面后，玩家视角回到UE4 出生点，类似观众，一定情况下可以看到点击背包前控制的角色。

**产生原因**
在游戏过程中产生原因后，忽然发现小地图能正常显示人物坐标和方向，此时脱离游戏控制，就能看见游戏场景中有两个pawn（实际上只有一个），而且第二个产生的pawn的摄像头是默认产生的，在头部那里，难以发现它是pawn（我还以为是空的观众）。
经排查，该背包界面中要显示角色的3D模型，所以在代码中创建了新的角色实例。而且在玩家先前操控的角色实例中，设置蒙皮步骤后就立刻设置controller去Possess该角色。

**解决**
这里面有两个问题：一个是需要创建pawn实例而不需要去控制它，另一个是创建实例的问题。
首先解决第一个问题，修改设置蒙皮的步骤，因为加载蒙皮是异步，所以在加载蒙皮（`setBody`）之前设定判别量（`_bControllerPossess`），在加载蒙皮后根据该判别量，选择是否设置controller去Possess该角色。
```lua
-- 设定该角色实例在加载蒙皮后，被controller控制
-- 该函数必须在 setBody 调用之前调用
function BattlePlayerBody:bePossessed()
	self._bControllerPossess = true
end
```
然后解决创建实例的问题，该问题表现为假如游戏中有两个玩家A和B，A玩家打开背包后会创建pawn实例，此时B玩家就能看到凭空出现一个pawn。
取消实例的创建，将实例替换为玩家控制的当前角色。根据显示3D模型的过程，将组件`SceneCaptureComponent` 添加到玩家控制的pawn上，采用白名单只获取角色蒙皮，修正组件的部分细节。

## 切换角色后，武器消失的问题
**问题描述**
从角色界面切换角色后，角色手中的武器消失，小地图显示错误，报错表示找不到pawn

**产生原因**
首先切换角色采用的方式是销毁旧角色，然后创建新角色。在之前的代码中，很多使用到playerPawn的地方都保存了旧的playerPawn作为私有变量，这导致在切换后就的playerPawn失效。
武器消失是特例，销毁旧角色时连同武器武器一起销毁，而创建角色装备新武器时，判断了当前武器若相同则不装备。

**解决**
有两种方式解决该问题:
第一种是实时获取最新的playerPawn
第二种是建立通知，在成功切换角色后，通知相关数据进行更新
第一种方式适合小范围且更新不频繁的情况，改动简单。第二种适合横跨场景，头显，单位等多个模块，也适合每帧更新的情况，改动复杂。

## 3D模型在角色切换后不刷新成新角色的问题
**问题描述**
先题：关于角色开关后的控制角色错误问题，跟大佬商讨过后还是需要创建新的UI角色，然后将角色设置为不可见。新角色被控制最后查明是蓝图中，character默认possess为player0，导致每次创建该角色，player的控制权就会转移过去。
现在的问题是：在角色界面中，点击切换角色，实际中玩家的角色成功切换，而且用作显示的旧UICharacter被销毁，新的UICharacter被创建，此时3D模型的角色却没有切换。

**产生原因**
显示用的RenderTarget 是附着在UICharacter 的组件上的，所以切换角色时，会跟随旧角色的销毁而销毁，然后换上新的RenderTarget。问题在于LGUI中，设置自定义的材质只能在UITexture中设置一次，后续的显示不支持在运行时切换自定义材质，这导致RenderTarget更新了，画面没有更新，所以重开角色界面后3D模型就刷新成新角色。

**解决**
将RenderTarget 的生命周期与角色界面绑定，即在角色界面中保存RenderTarget，然后随着UICharacter的创建与销毁，在UICharacter 上的特定相机动态去绑定RenderTarget

## 进入战斗场景后敌人和药水瓶子不出现在场景中
**问题描述**
敌人和药水瓶子这些单位，是围绕playerBodyActor生成的。在进入场景后，这些单位就开始Tick并获取playerBodyActor的location，然后再其周围生成。而现状是进入场景后没有生成这些单位。

**产生原因**
在进入场景后，虽然player是先setBody的，但是Body资源的加载是异步的，所以刚开始获取不到playerBodyActor的location，所以生成的位置错误

**解决**
进入战斗场景后就先执行Tick，在Tick中检查直到存在playerBodyActor，再进行单位的创建

## 背包格子的加载问题
**问题描述**
背包格子的资源加载是异步的，进入背包界面后就有添加格子的需求，而此时格子的actor资源可能还没加载出来。如果使用预加载，则无法动态加载多个格子，预加载后使用的格子actor都是同一个。

**产生原因**
如问题描述

**解决**
使用任务队列保存将执行的添加或移除任务，在每帧tick中取出任务并尝试进行任务，任务成功完成时便移除任务。
这种任务队列的方式加上通知回调机制，还能支持在打开背包界面时动态添加格子。
关于传参的问题，在任务的描述格式中添加param 参数，保存一个表，用来表示可能需要用到的参数
**补充**
实际上预加载后，保留res的话可以在需要的时候实例化格子！

## 背包添加格子失败的问题
**问题描述**
当前的背包设计是这样的：背包在初始化的时候就获取player的物品列表，然后添加“添加物品任务”，在tick中就去获取任务并解决，即背包的格子的添加和删除是通过任务和tick来执行的。
在初次获取物品列表能够成功添加背包格子，但是当关闭背包界面后，添加物品，再打开背包，此时新添加的物品没有出现

**产生原因**
找半天发现任务没有被执行，最后发现 ViewComponent 在构造中使用tick 有问题。在关闭界面后该 tick就中断了，之后再打开界面就不会继续执行 tick。

**解决**
不要再构造中使用tick，在初始化的时候手动设置计时器并在析构中销毁。
这时候发现另一个问题，在关闭界面后添加任务时，会添加无法解析的任务并造成任务队列忙等。最后才发现是传参问题，传参应该是taskTable，但是传了task，导致任务表无法解析

## 先打开背包然后打开角色报错
**问题描述**
先打开背包界面，关闭背包界面，然后打开角色界面（添加物品），此时报错。

**产生原因**
背包的方法前的类名全写错了。。。。

**解决**
改好就好。。。。

## 背包找不到父类方法
**问题描述**
在使用框架中的滑动列表编写新背包后，滑动列表找不到父类方法

**产生原因**
补充构造函数后发现是该类找不到父类方法，最后问大佬之后才知道是类的导入顺序错误，父类在子类之后

**解决**
把父类移到子类之前就好

## 背包第一个格子图片资源加载不出来
**问题描述**
滑动列表在添加公共格子时，第一个格子的在设置图片时总是失败。在运行时，检查图片是设置成功的，但是实际显示上还是默认的图片资源，没有设置成功

**产生原因**
偶然发现关闭分帧加载能解决这个问题，继续找下去才发现真正原因。因为此次采用的资源加载是使用时异步加载的，所以第一次使用资源时要load资源，会较慢加载出来。而在分帧加载过程中，因为之前的定时器变量名错误，即为空，分帧加载实际上是每帧都加载，所以该问题是加载速度过快导致的。

**解决**
将原来的全局变量名修正，设置分帧加载为0.02s

## 药品点击事件无效
**问题描述**
需求是点击场景中的物品，场景中的物品做出对应反应。问题是在添加actor的clicked事件或touch事件后，物体还是没有反应。在这过程中，项目的配置从刚开始的重写输入事件，到后面取消重写，这里梳理一下物品点击事件。从始至终都应用了LGUI作为UI

**产生原因**
到底就是没设置好

**解决**
梳理一下如何开启clicked事件和touch事件，按需设置就好
clicked事件
> 自定义controller类并应用，设置controller类中的Mouse Interface，开启Enable Clicked Events，就可以添加对应物品clicked事件。
要注意的是，就算开启controller类中的Mouse Over Events，UI的点击事件与场景中的物品的clicked事件也不冲突！甚至重叠的情况下UI的点击事件和clicked事件都可以触发！

touch事件
> 自定义controller类并应用，设置controller类中的Mouse Interface，开启Enable Touch Events。然后打开项目设置，在input中找到Use Mouse for Touch，这个设置很重要！该设置将鼠标事件变成touch，即没有clicked事件，是touch事件！之后就可以添加对应物品的touch事件了。
要注意的是，就算开启touch事件，UI的点击事件与场景中的物品的touch事件不冲突！甚至重叠的情况下UI的点击事件和touch事件都可以触发！

## 滑动列表的格子在特定参数的情况下显示不全
**问题描述**
当格子的宽高占画布的大小的一半以上时，只创建两个格子后第二个格子会滑不上来

**产生原因**
找了一下是计算问题，导致添加新格子后画布大小没有更新。
我所理解的原计算方法是，先初始化计算画布能装下的格子数量，在添加的格子数量超出画布所能装下的数量后，再更新画布的大小。如果我理解没错的话，那就是初始化计算画布能装下的格子数量错了。当画布是上下滑动的时候，初始化画布计算行数时是画布大小除以格子大小之后，再向上取整后+1,最后这个+1应该是不用的，而且应该是向下取整

**解决**
由于不知道之前的计算方法有没有处于什么别的考量，所以暂未解决，总之要不就是更新画布大小的判断错了，要不就是初始化画布能装下的格子数量错了，导致画布大小没有更新
**补充**
已由大佬解决

---
## --- 将界面从LGUI 换成 umg 后 ---


## 插件资源加载问题
**问题描述**
在插件中绘制的 umg Common 组件无法加载

**产生原因**
ViewPresentor 中写死了界面资源的加载路径，配置指向了项目中的View文件

**解决**
跟大佬讨论后，决定扩充资源加载列表的传入格式。
首先对比ue 跟 unity 的不同，ue 加载资源并不用预先配置好各种资源应该存放的位置，ue 加载资源的方式只需要传入资源的路径即可。所以将加载路径改成三类：项目中，插件中，自定义。
资源加载列表的格式扩充为 {string/table}，兼容字符串和表，如果为表格，其内容就是资源加载路径和资源类型（用来补充资源加载路径的前缀），如果为字符串，则使用默认的资源类型（项目资源）。
在获取列表之后，还需要资源路径解释器（其实只是一个自定义函数）获取完整资源信息，就是资源加载路径和资源类型

## 插件中是否提供 ViewPresentor
**问题描述**
插件中提供了一些公共的 ViewComponent，要使用这些 ViewComponent 需要将他们装在在 ViewPresentor 上，才能算是一个界面。
首先尝试了提供ViewPresentor，首先需要给数据结构ViewSetting提供一些默认配置，默认加载插件中的ViewPresentor，之后报了找不到改Presentor的错误，原因在自动生成lua 脚本配置的 py 文件中，只会自动生成项目的脚本配置，对于插件中新建的文件需要自己添加配置。
该过程中涉及多个核心组件，后续添加新的ViewPresentor的步骤也较为繁琐。

**产生原因**
如问题描述

**解决**
在经过一段时间的实践后，发现插件要提供 ViewPresentor，修改的地方多且涉及核心组件，鉴于 ViewPresentor 的简单，决定插件不提供 ViewPresentor

## 通用消息管理器失效
**问题描述**
通用消息管理器是一个便捷的显示消息的入口，只需要传入消息和必要的配置便可展示消息窗口。但是插件不提供Presentor了，所以并没有窗口界面。

**产生原因**
如问题描述

**解决**
Presentor 由项目提供，管理器保留Presentor配置给项目使用

## 如何实现消息盒的拖拽
**问题描述**
消息盒保留可拖拽的配置，可拖拽指消息窗口可上下滑动查看信息。

**产生原因**
如问题描述

**解决**
ScrollBox 嵌套 SizeBox，用SizeBox撑开滑动列表实现可上下滑动。

## 全屏界面，不带遮罩，背后的场景不消失
**问题描述**
假设A界面是全屏界面，不带遮罩。A界面在显示的时候会将当前界面进行压栈，A界面在关闭的时候会将栈顶界面进行出栈。将A界面的背景设为透明之后，可以观察到，在A界面打开关闭之后，后续再打开，ViewPresentor都不会对当前界面进行压栈

**产生原因**
在第一次打开时候会进行资源的加载，而压栈这个操作是写在资源加载的回调函数中，当后续打开不进行资源加载时，便不执行压栈操作了

**解决**
如果不进行资源加载，即不是第一次打开界面时，补充执行界面加载完毕的回调

## 非循环滑动列表加载时滑动显示不全
**问题描述**
分帧刷新能观察到，在非循环滑动列表第一次加载过程中，格子未加载完全时去滑动会导致整个滑动窗口的容器大小不能填满窗口大小。

**产生原因**
1、滑动列表采用虚拟页数，实际页数只有1页，所有格子会存在cellArray中。
2、在分帧刷新时，每帧检查cellIndex，满足个数就removetimer。每次Tick创建新的格子cell的时候，会动态添加到cellArray并自增cellIndex。
3、当上滑操作时，该页数的第一行会移动到最后一行，并更新cellIndex，以达到更新cell页面的目的。下滑同理。
基于以上三点，在还在创建cell的时候进行滑动，会导致cellIndex更改，使分帧刷新提前停止，导致滑动窗口的容器大小错误，并且格子Index出现断层现象。

**解决**
1、先解决创建分帧刷新提前停止的问题，其实就是Tick每帧检查的结束语句错误，原判断是根据将要产生的格子的下标cellIndex，当滑动操作时就会修改cellIndex，使Tick提前停止。询问大佬后，滑动操作的cellIndex 应该为local，修好就行。
2、保证每页的格子数量完整后，调整滑动操作。在创建格子的时候禁用滑动刷新，仅记录滑动状态，在格子创建完成时手动调用滑动刷新一次。

## 非循环滑动列表末尾上拉显示不全
**问题描述**
在非循环滑动列表滑到底部之后，再往上滑会出现规律性的空行，并且此时滑到第一行后还能往上滑

**产生原因**
在滑动到底部的时候，cellArray 还会进行一次更新（实际行数本就比页面显示的行数多一行），将页面的第一行移动到最后一行，但是最后一行已经没有需要显示的cell了，而这些移动的cell因为已经超出了格子数量，所以只设置了属性但没有更新Row，导致下滑的行位置getRow为旧数据，新行丢失

**解决**
有两种解决方案：
1、判断最后一行是否已经生成，是则不再上滑更新cell
2、修复最后一行超出格子数量的cell的Row问题，转用setVisible替代，但是下滑时要重置Visible状态
这里主要采用第二种方案，并用第一种方案优化

# C++问题

## 关于error LNK2019: 无法解析的外部符号 "__declspec(dllimport) private: static class UClass * __cdecl
**解决**
这问题一看就是dll库没有链接好，我是cs文件中忘了添加相关模块。
有人是`Intermedidate`文件没有更新，删了重新编译就好，这种盲猜是改了命名。
[Unreal Engine 4 开发中遇到的部分问题](https://www.codeleading.com/article/55071278553/)
[GetPrivateStaticClass()](https://forums.unrealengine.com/t/getprivatestaticclass-unresolved-external-between-modules/410842)

# 未解决问题

## 药品点击事件异常
**问题描述**
场景中点击药品后，有时候药品不会消失，背包却添加了物品，此时药品可以无限次点击，背包总是成功添加物品。代码上应该是药品消失后，再向背包添加物品。


## 循环滑动窗口滑动事件响应问题
**问题描述**
由于umg组件没有循环滑动窗口，所以该窗口是的滑动事件是自定义实现的。鼠标进入该窗口后，只有在窗口底部才产生滑动事件，在窗口上的item中进行操作时不产生滑动事件

**产生原因**
先说自定义滑动事件，从UserWidget派生EventWidget类，然后重写NativeOnMouseMove事件，使用自定义滑动事件的蓝图继承EventWidget即可。其中滑动事件刚开始会判断 mouse button down，但是该事件会被其他组件接收，导致widget 不产生该事件。如果用鼠标右键滑动来处理窗口的滚动，mouse right down 会触发OnMouseLeave，导致mouse move事件无法触发。
scroll list的实现是不走界面的鼠标点击事件的，可重写clicked事件实验。

**解决**
